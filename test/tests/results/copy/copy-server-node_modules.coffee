# test results: copy-server-node_modules
# ======================================
task         = 'copy-server-node_modules'
async        = require 'asyncawait/async'
await        = require 'asyncawait/await'
Promise      = require 'bluebird'
fs           = Promise.promisifyAll require 'fs'
config       = require "#{process.cwd()}/temp/config.json"
tests        = require("#{config.paths.abs.test.helpers}/tests") config
rbServerPath = config.paths.abs.test.app.dist.server.build
rbDirName    = config.pkgs.rb.name
jExpect      = 'jasmine-expect'


# tests
# =====
describe task, ->
	appConfig  = undefined
	appModules = undefined

	beforeAll ->
		appConfig  = tests.get.app.config()
		appModules = appConfig.node_modules.rb.modules

	msg1 = "should copy node_modules to server dist #{rbDirName} dir"
	it msg1, async (done) ->
		try dirs = await fs.readdirAsync "#{rbServerPath}/node_modules"
		expect(dirs).toBeArray()
		for mod in appModules
			continue if mod.indexOf('jasmine') isnt -1
			expect(dirs).toContain mod

		done()

	msg2  = "should copy node_module #{jExpect} to server dist #{rbDirName} dir "
	msg2 += "if testing server"
	it msg2, async (done) ->
		return done() unless config.build.is.testServer
		try stats = await fs.statAsync "#{rbServerPath}/node_modules/#{jExpect}"
		result = stats?.isDirectory()
		expect(result).toBeDefined()
		done()