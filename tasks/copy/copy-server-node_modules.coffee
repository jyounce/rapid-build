module.exports = (gulp, config) ->
	q = require 'q'

	runTask = (src, dest) ->
		defer = q.defer()
		gulp.src src
			.pipe gulp.dest dest
			.on 'end', ->
				defer.resolve()
		defer.promise

	runTasks = (modules) ->
		tasks = []
		defer = q.defer()
		modules.forEach (module) ->
			tasks.push ->
				runTask(
					config.glob.node_modules.src[module]
					config.node_modules.dist.modules[module]
				)
		tasks.reduce(q.when, q()).done -> defer.resolve()
		defer.promise

	# register task
	# =============
	gulp.task "#{config.rb.prefix.task}copy-server-node_modules", ->
		runTasks ['express', 'q']